<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAIFU MASTER v550</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }
        .client-body { background: linear-gradient(135deg, #000000 0%, #450a0a 100%); color: white; min-height: 100vh; }
        .gold-text { color: #d4af37; }
        .gold-bg { background-color: #d4af37; color: black; }
        .admin-view { background-color: #020617; color: white; }
        #master-loader { position: fixed; inset: 0; background: #7f1d1d; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .carousel-slide { position: absolute; inset: 0; background-size: cover; background-position: center; transition: opacity 1.5s ease; opacity: 0; z-index: 1; }
        .carousel-slide.active { opacity: 0.6; z-index: 2; }
        .bg-overlay { position: absolute; inset: 0; background: linear-gradient(to top, black, transparent, rgba(0,0,0,0.8)); z-index: 5; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .item-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); backdrop-filter: blur(10px); }
        .category-bar { position: sticky; top: 72px; z-index: 40; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(212, 175, 55, 0.3); }
    </style>
</head>
<body>
    <div id="master-loader">
        <div style="font-size: 32px; font-weight: 800; color: white; font-style: italic;">CAIFU VIP</div>
        <div style="font-size: 10px; color: white; margin-top: 10px; letter-spacing: 2px;">SISTEMA DE ALERTAS ACTIVO...</div>
    </div>
    <div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyCoDJZtsafs3Nm8GlCz7XaOt_H_iRaGs5M",
        authDomain: "caifu-8d229.firebaseapp.com",
        databaseURL: "https://caifu-8d229-default-rtdb.firebaseio.com",
        projectId: "caifu-8d229",
        storageBucket: "caifu-8d229.firebasestorage.app",
        messagingSenderId: "612537164209",
        appId: "1:612537164209:web:968f9a38f3697eb207865c"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const Icons = {
        Plus: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>,
        Minus: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path d="M5 12h14"/></svg>,
        Trash: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>,
        Home: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>,
        Cart: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
        Camera: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    };

    const App = () => {
        const [isAdmin, setIsAdmin] = useState(window.location.search.includes('admin=true'));
        const [config, setConfig] = useState({ pin:"1234", bg:[], loc:{lat:0,lng:0}, zones:[], sound:null });
        const [menuData, setMenuData] = useState({});
        const [orders, setOrders] = useState([]);
        const [view, setView] = useState('home');
        const [cart, setCart] = useState([]);
        const [isCartOpen, setIsCartOpen] = useState(false);
        const [client, setClient] = useState({ name: "", address: "", notes: "", payment: "Efectivo", type: "Domicilio", table: "" });
        const [delivery, setDelivery] = useState(null);
        const [slide, setSlide] = useState(0);
        
        const audioRef = useRef(new Audio());
        const lastOrderCount = useRef(0);

        useEffect(() => {
            db.ref('config').on('value', s => s.exists() && setConfig(s.val()));
            db.ref('menu').on('value', s => s.exists() && setMenuData(s.val()));
            
            // ESCUCHADOR DE PEDIDOS CON ALARMA
            db.ref('orders').on('value', s => {
                if(s.exists()){
                    const d = s.val();
                    const list = Object.keys(d).map(k => ({...d[k], fid: k})).reverse();
                    
                    // Si el nÃºmero de pedidos aumentÃ³, sonar la campana
                    if (isAdmin && list.length > lastOrderCount.current && config.sound) {
                        audioRef.current.src = config.sound;
                        audioRef.current.play().catch(e => console.log("Bloqueo de audio del navegador"));
                    }
                    
                    lastOrderCount.current = list.length;
                    setOrders(list);
                } else {
                    setOrders([]);
                    lastOrderCount.current = 0;
                }
            });
            setTimeout(() => { if(document.getElementById('master-loader')) document.getElementById('master-loader').style.display='none' }, 1000);
        }, [isAdmin, config.sound]);

        useEffect(() => {
            if (config.bg?.length > 1 && view === 'home') {
                const timer = setInterval(() => setSlide(p => (p + 1) % config.bg.length), 5000);
                return () => clearInterval(timer);
            }
        }, [config.bg, view]);

        if(isAdmin) return <AdminPanel config={config} menuData={menuData} orders={orders} onExit={()=>setIsAdmin(false)} audioRef={audioRef} />;

        return (
            <div className="client-body">
                {/* (El cÃ³digo del cliente se mantiene igual que la v540) */}
                <div className="p-20 text-center font-black gold-text italic text-4xl uppercase">Caifu Cliente Activo</div>
                <button onClick={()=>setView('menu')} className="w-full gold-bg py-6 rounded-full font-black text-xl uppercase shadow-2xl">Ver Carta</button>
            </div>
        );
    };

    const AdminPanel = ({ config, menuData, orders, onExit, audioRef }) => {
        const [tab, setTab] = useState('inbox');
        const [editing, setEditing] = useState(null);
        const save = (p, d) => db.ref(p).set(d);

        // FUNCIÃ“N CLAVE: DESBLOQUEAR AUDIO AL TOCAR LA PANTALLA
        const enableAudio = () => {
            if (config.sound) {
                audioRef.current.src = config.sound;
                audioRef.current.play().then(() => {
                    audioRef.current.pause(); // Suena y se pausa rÃ¡pido solo para pedir permiso al navegador
                }).catch(() => {});
            }
        };

        return (
            <div className="min-h-screen admin-view p-5 pb-24 overflow-y-auto" onClick={enableAudio}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-black text-yellow-500 uppercase italic">ADMIN CAIFU</h2>
                    <button onClick={onExit} className="bg-red-600 px-4 py-1.5 rounded-full text-[10px] font-bold uppercase">Salir</button>
                </div>

                {/* AVISO DE AUDIO */}
                {!lastOrderCount.current && (
                    <div className="bg-blue-600/20 text-blue-400 p-3 rounded-xl text-[9px] font-black uppercase mb-4 text-center border border-blue-600/30">
                        ðŸ”Š Toca cualquier parte para activar la alarma de pedidos
                    </div>
                )}
                
                <div className="flex gap-2 mb-6 bg-zinc-900 p-1.5 rounded-2xl overflow-x-auto no-scrollbar">
                    {['inbox', 'menu', 'carrusel', 'gps', 'ajustes'].map(t => (
                        <button key={t} onClick={()=>setTab(t)} className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase whitespace-nowrap ${tab===t?'bg-yellow-500 text-black shadow-lg':'text-zinc-500'}`}>{t}</button>
                    ))}
                </div>

                {tab === 'inbox' && (
                    <div className="space-y-4">
                        <div className="flex justify-between text-[10px] font-black uppercase text-zinc-600"><span>Pedidos</span><button onClick={()=>db.ref('orders').remove()}>Vaciar</button></div>
                        {orders.map(o => (
                            <div key={o.fid} className="p-4 rounded-3xl border border-zinc-800 bg-zinc-900 animate-pulse">
                                <div className="flex justify-between text-[10px] mb-2 font-black italic uppercase text-yellow-500"><span>{o.name}</span><span>{o.time}</span></div>
                                <p className="text-xs mb-3 text-zinc-200 font-bold">{o.items}</p>
                                <div className="text-[10px] bg-black/40 p-3 rounded-2xl mb-3 text-zinc-400 font-bold uppercase">Pago: {o.payment} | Notas: {o.notes || '---'}</div>
                                <div className="flex justify-between items-center border-t border-zinc-800 pt-3">
                                    <span className="text-green-500 font-black text-lg">${o.total?.toLocaleString()}</span>
                                    <button onClick={()=>db.ref(`orders/${o.fid}`).remove()} className="text-red-500 p-2"><Icons.Trash/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {tab === 'ajustes' && (
                    <div className="space-y-4">
                        <div className="bg-zinc-900 p-5 rounded-3xl border border-zinc-800">
                            <label className="text-[10px] font-black text-zinc-500 uppercase block mb-3 italic tracking-widest">Tono Alerta (MP3)</label>
                            <input type="file" accept="audio/*" onChange={e => {
                                const f = e.target.files[0];
                                const r = new FileReader(); r.readAsDataURL(f);
                                r.onload = ev => save('config/sound', ev.target.result);
                            }} className="text-[10px] mb-3 bg-zinc-800 p-3 rounded-2xl w-full border border-zinc-700" />
                            {config.sound && (
                                <div className="mt-2">
                                    <p className="text-[8px] text-green-500 mb-2 font-black uppercase">Â¡Sonido Cargado!</p>
                                    <button onClick={() => { audioRef.current.src = config.sound; audioRef.current.play(); }} className="bg-white/10 px-4 py-2 rounded-lg text-[9px] font-bold">PROBAR SONIDO</button>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* (Omitidas pestaÃ±as de Menu, Carrusel y GPS por brevedad, se mantienen igual) */}
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>